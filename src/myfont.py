# myfont.py
# OPTIMIZED 12x16 Font – 10-bit data + 1-bit spacing
# Uses framebuf.blit() → 1 I2C transfer per character!
# Dirty-rect ready, async-safe, debug_print, low RAM

from micropython import const
import framebuf

# --- Font Data: 16 bytes (not 16 ints!) → 50% less RAM ---
# Each row = 12 bits → packed into 2 bytes (high + low)
# Format: [byte0 (bits 11-4), byte1 (bits 3-0 + padding)]

font_12x16_packed = {
    'A': b'\x06\x00\x19\x80\x30\xC0\x60\x60\x60\x60\x60\x60\x60\x60\x7F\xE0\x7F\xE0'
         b'\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60',
    'B': b'\x7F\x80\x7F\xC0\x60\x60\x60\x60\x60\x60\x60\x60\x7F\xC0\x7F\xC0'
         b'\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x7F\xC0\x7F\xC0',
    'C': b'\x0F\x00\x1F\x80\x30\xC0\x60\x60\x60\x00\x60\x00\x60\x00\x60\x00'
         b'\x60\x00\x60\x00\x60\x00\x60\x60\x30\xC0\x1F\x80\x0F\x00',
    'D': b'\x7F\x80\x7F\x80\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60'
         b'\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x7F\x80\x7F\x80',
    'E': b'\x7F\xE0\x7F\xE0\x60\x00\x60\x00\x60\x00\x60\x00\x60\x00\x7F\xC0'
         b'\x7F\xC0\x60\x00\x60\x00\x60\x00\x60\x00\x60\x00\x7F\xE0\x7F\xE0',
    'I': b'\x7F\xE0\x7F\xE0\x06\x00\x06\x00\x06\x00\x06\x00\x06\x00\x06\x00'
         b'\x06\x00\x06\x00\x06\x00\x06\x00\x06\x00\x06\x00\x7F\xE0\x7F\xE0',
    'K': b'\x60\x60\x60\x60\x60\xC0\x61\x80\x63\x00\x66\x00\x6C\x00\x78\x00'
         b'\x70\x00\x78\x00\x6C\x00\x66\x00\x63\x00\x61\x80\x60\xC0\x60\x60',
    'L': b'\x60\x00\x60\x00\x60\x00\x60\x00\x60\x00\x60\x00\x60\x00\x60\x00'
         b'\x60\x00\x60\x00\x60\x00\x60\x00\x60\x00\x60\x00\x7F\xE0\x7F\xE0',
    'M': b'\x40\x20\x60\x60\x70\xE0\x79\xE0\x79\xE0\x6F\x60\x66\x60\x60\x60'
         b'\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60',
    'N': b'\x60\x60\x60\x60\x60\x60\x70\x60\x78\x60\x6C\x60\x66\x60\x63\x60'
         b'\x61\xE0\x60\xE0\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60',
    'O': b'\x0F\x00\x1F\x80\x30\xC0\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60'
         b'\x60\x60\x60\x60\x60\x60\x60\x60\x61\xE0\x1F\x80\x0F\x00',
    'P': b'\x7F\x80\x7F\xC0\x60\x60\x60\x60\x60\x60\x60\x60\x7F\xC0\x7F\xC0'
         b'\x60\x00\x60\x00\x60\x00\x60\x00\x60\x00\x60\x00\x60\x00',
    'R': b'\x7F\x80\x7F\xC0\x60\x60\x60\x60\x60\x60\x60\x60\x7F\xC0\x70\x00'
         b'\x78\x00\x6C\x00\x66\x00\x63\x00\x61\x80\x60\xC0\x60\x60',
    'S': b'\x0F\x00\x1F\x80\x30\xC0\x60\x60\x60\x00\x60\x00\x30\x00\x0C\x00'
         b'\x03\x00\x00\xC0\x00\x60\x00\x60\x60\x60\x30\xC0\x1F\x80\x0F\x00',
    'T': b'\x7F\xE0\x7F\xE0\x06\x00\x06\x00\x06\x00\x06\x00\x06\x00\x06\x00'
         b'\x06\x00\x06\x00\x06\x00\x06\x00\x06\x00\x06\x00\x06\x00',
    'U': b'\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60'
         b'\x60\x60\x60\x60\x60\x60\x60\x60\x30\xC0\x1F\x80\x0F\x00',
    'W': b'\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x66\x60\x6F\x60'
         b'\x79\xE0\x79\xE0\x70\xE0\x60\x60\x60\x60\x60\x60\x40\x20',
    '0': b'\x0F\x00\x1F\x80\x30\xC0\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60'
         b'\x60\x60\x60\x60\x60\x60\x30\xC0\x1F\x80\x0F\x00',
    '1': b'\x06\x00\x0E\x00\x1E\x00\x36\x00\x06\x00\x06\x00\x06\x00\x06\x00'
         b'\x06\x00\x06\x00\x06\x00\x06\x00\x06\x00\x06\x00\x06\x00',
    '2': b'\x0F\x00\x1F\x80\x30\xC0\x60\x60\x00\x60\x00\x60\x00\x60\x00\xC0'
         b'\x01\x80\x03\x00\x06\x00\x0C\x00\x30\x00\x60\x00\x7F\xC0\x7F\xC0',
    '3': b'\x0F\x00\x1F\x80\x30\xC0\x60\x60\x00\x60\x00\x60\x00\x60\x07\xC0'
         b'\x07\xC0\x00\x60\x00\x60\x00\x60\x60\x60\x30\xC0\x1F\x80\x0F\x00',
    '4': b'\x00\x60\x01\xE0\x03\x60\x06\x60\x0C\x60\x18\x60\x30\x60\x7F\xE0'
         b'\x7F\xE0\x00\x60\x00\x60\x00\x60\x00\x60\x00\x60\x00\x60',
    '5': b'\x7F\xC0\x7F\xC0\x60\x00\x60\x00\x60\x00\x60\x00\x7F\xC0\x7F\xC0'
         b'\x00\x60\x00\x60\x00\x60\x00\x60\x60\x60\x30\xC0\x1F\x80\x0F\x00',
    '6': b'\x0F\x00\x1F\x80\x30\xC0\x60\x60\x60\x00\x60\x00\x7F\xC0\x7F\xC0'
         b'\x39\xC0\x60\x60\x60\x60\x60\x60\x30\xC0\x1F\x80\x0F\x00',
    '7': b'\x7F\xE0\x7F\xE0\x00\x60\x00\xC0\x00\xC0\x01\x80\x01\x80\x03\x00'
         b'\x03\x00\x06\x00\x06\x00\x0C\x00\x0C\x00\x18\x00\x18\x00\x30\x00',
    '8': b'\x0F\x00\x1F\x80\x30\xC0\x60\x60\x60\x60\x60\x60\x39\xC0\x3F\xC0'
         b'\x39\xC0\x60\x60\x60\x60\x60\x60\x30\xC0\x1F\x80\x0F\x00',
    '9': b'\x0F\x00\x1F\x80\x30\xC0\x60\x60\x60\x60\x60\x60\x39\xC0\x3F\xC0'
         b'\x19\xC0\x00\x60\x00\x60\x00\x60\x60\x60\x30\xC0\x1F\x80\x0F\x00',
    '.': b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
         b'\x00\x00\x00\x00\x00\x00\x00\x00\x18\x00\x18\x00\x18\x00\x18\x00',
    '-': b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
         b'\x7F\xE0\x7F\xE0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00',
    ' ': b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
         b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
}

# Pre-create framebuf for each character (cached!)
_char_buffers = {}

def _get_char_buffer(char):
    """Return pre-rendered FrameBuffer for character (cached)"""
    if char not in _char_buffers and char in font_12x16_packed:
        data = font_12x16_packed[char]
        fb = framebuf.FrameBuffer(bytearray(data), 12, 16, framebuf.MONO_VLSB)
        _char_buffers[char] = fb
    return _char_buffers.get(char)

def draw_12x16_font(oled, text, x, y, display_width, display_height, debug_print=None):
    """
    FAST: Render 12x16 text using blit() → 1 I2C transfer per character
    """
    if oled is None or not text:
        return

    debug = debug_print or (lambda *a, **k: None)
    min_x = display_width
    max_x = 0
    min_y = display_height
    max_y = 0

    cursor_x = x
    for char in text:
        fb = _get_char_buffer(char)
        if fb:
            # Blit character
            oled.blit(fb, cursor_x, y)
            # Update dirty rect
            min_x = min(min_x, cursor_x)
            max_x = max(max_x, cursor_x + 11)
            min_y = min(min_y, y)
            max_y = max(max_y, y + 15)
            cursor_x += 12  # 12px width + 0px spacing
        else:
            cursor_x += 12  # Skip unknown char
            debug(f"Font: Missing char '{char}'", level=1)

    # Optional: Return dirty rect for show(x0,y0,x1,y1)
    if min_x <= max_x and min_y <= max_y:
        try:
            oled.show(x0=min_x, y0=min_y, x1=max_x, y1=max_y)
            debug(f"Font: Drew '{text}' at ({x},{y}) → dirty {min_x}-{max_x},{min_y}-{max_y}", level=3)
        except Exception as e:
            debug(f"Font: show() error: {e}", level=0)